FROM node:18.14.2 AS builder
RUN mkdir -p /app
WORKDIR /app
ADD . .
RUN mkdir -p video-storage

RUN yarn remove bcrypt
RUN yarn add bcrypt
RUN yarn install
RUN yarn build

ENV JWT_SECRET=my_secret
ENV HASH_ROUNDS=10

ARG DB_HOST
ENV DB_HOST ${DB_HOST}
ARG DB_PORT
ENV DB_PORT ${DB_PORT}
ARG DB_USERNAME
ENV DB_USERNAME ${DB_USERNAME}
ARG DB_PASSWORD
ENV DB_PASSWORD ${DB_PASSWORD}
ARG DB_DATABASE
ENV DB_DATABASE ${DB_DATABASE}

ARG KAKAO_JAVASCRIPT_KEY
ENV KAKAO_JAVASCRIPT_KEY ${KAKAO_JAVASCRIPT_KEY}
ARG KAKAO_REDIRECT_URI
ENV KAKAO_REDIRECT_URI ${KAKAO_REDIRECT_URI}
ARG GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_ID ${GOOGLE_CLIENT_ID}
ARG GOOGLE_PASSWORD
ENV GOOGLE_PASSWORD ${GOOGLE_PASSWORD}

CMD yarn start:prod